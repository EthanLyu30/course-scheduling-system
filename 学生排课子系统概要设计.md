# 学生排课子系统概要设计

## 一、架构风格选择与说明

### 1.1 架构风格选择

本系统选择**分层架构（Layered Architecture）**与**微服务架构（Microservices Architecture）**相结合的混合架构风格。

### 1.2 选择理由

**（1）分层架构的适用性**

学生排课子系统作为教务管理系统的重要组成部分，具有明确的业务层次划分需求。采用分层架构可以将系统划分为表现层、业务逻辑层、数据访问层等，具有以下优势：

- **关注点分离**：各层职责明确，表现层负责用户交互，业务层处理核心排课逻辑，数据层管理持久化，降低了系统复杂度
- **可维护性强**：当需求变更时（如调整时间偏好算法），只需修改对应层次，不影响其他层
- **团队协作友好**：前端团队、后端团队、数据库团队可并行开发
- **符合系统需求**：需求文档中强调"模块化设计，功能组件相对独立，便于后期扩展与维护"

**（2）微服务思想的引入**

考虑到系统需要支持5000名学生同时在线、99.5%的可用性目标，以及与教务协调子系统的集成需求，在业务层采用微服务思想进行模块划分：

- **高并发支持**：各服务可独立扩展，选课高峰期可针对性扩容"意愿表达服务"
- **故障隔离**：单个服务故障不会导致整个系统瘫痪，符合高可用性要求
- **技术异构性**：排课算法模块可采用Python等更适合算法实现的技术栈
- **与外部系统集成**：便于与教务协调子系统、身份认证系统等进行API对接

**（3）架构风格总结**

综合以上分析，本系统采用"分层+微服务"的混合架构：
- **宏观层面**：采用经典的三层/四层分层架构，保证系统结构清晰
- **业务层内部**：按功能域拆分为多个相对独立的服务模块，体现微服务思想
- **通信方式**：层间采用同步调用，服务间采用RESTful API和消息队列相结合

---

## 二、系统架构图

### 2.1 系统整体架构图（UML构件图）

![学生排课子系统构件图](./学生排课子系统构件图.png)

### 2.2 构件图详细说明

#### 2.2.1 分层结构说明

本系统采用四层架构设计，各层职责明确、边界清晰：

| 层次 | 包含构件 | 主要职责 |
|------|----------|----------|
| **表现层** | Web前端应用、移动端应用、管理后台、API网关 | 负责用户交互界面展示和请求统一入口管理 |
| **业务逻辑层** | 6个核心业务服务 | 实现系统核心业务逻辑，处理时间偏好、课程选择、意愿表达等功能 |
| **数据访问层** | 数据访问对象(DAO)、缓存管理器、消息队列适配器 | 封装数据持久化操作，提供统一的数据访问接口 |
| **数据存储层** | MySQL数据库、Redis缓存、对象存储 | 负责数据的物理存储，包括关系数据、缓存数据和文件对象 |

#### 2.2.2 核心构件说明

**（1）表现层构件**

| 构件名称 | 构件类型 | 功能描述 |
|----------|----------|----------|
| Web前端应用 | `<<web client>>` | 基于Vue.js框架开发的单页应用，提供响应式UI界面，支持PC端浏览器访问 |
| 移动端应用 | `<<mobile client>>` | 响应式Web应用，支持PWA离线访问，针对触摸操作进行优化 |
| 管理后台 | `<<admin panel>>` | 管理员操作界面，提供数据监控、系统配置等后台管理功能 |
| API网关 | `<<gateway>>` | 系统统一入口，负责请求路由、限流熔断、认证鉴权和日志记录 |

**（2）业务逻辑层构件**

| 构件名称 | 构件类型 | 功能描述 | 提供的接口 |
|----------|----------|----------|------------|
| 时间偏好管理服务 | `<<service>>` | 管理学生每周可用时间段设置，支持模板应用、冲突检测和历史偏好复用 | ITimePreference |
| 课程信息服务 | `<<service>>` | 提供课程查询、热度统计、评价管理和先修课验证功能 | ICourseInfo |
| 意愿表达服务 | `<<service>>` | 处理学生课程意愿的优先级设置、理由填写、冲突预警和意愿提交 | IWishExpression |
| 排课结果服务 | `<<service>>` | 生成个人课表、计算满足率分析、推荐替代方案、支持多格式导出 | IScheduleResult |
| 反馈支持服务 | `<<service>>` | 收集用户满意度评分、文字反馈，支持截图/录屏上传和在线帮助 | IFeedbackService |
| 通知服务 | `<<service>>` | 发送站内消息、邮件和短信等多渠道通知，处理课表变更提醒 | INotification |

**（3）数据访问层构件**

| 构件名称 | 构件类型 | 功能描述 |
|----------|----------|----------|
| 数据访问对象 | `<<DAO>>` | 封装MySQL数据库的CRUD操作，提供ORM映射，屏蔽底层数据库差异 |
| 缓存管理器 | `<<cache manager>>` | 管理Redis缓存的读写操作，实现热点数据缓存策略，提升访问性能 |
| 消息队列适配器 | `<<message adapter>>` | 封装异步消息的发送和接收，支持意愿提交和通知发送等异步场景 |

**（4）数据存储层构件**

| 构件名称 | 构件类型 | 功能描述 |
|----------|----------|----------|
| MySQL数据库 | `<<relational>>` | 存储学生信息、课程信息、时间偏好、意愿数据、排课结果等结构化数据 |
| Redis缓存 | `<<in-memory>>` | 存储会话信息、热点课程数据、课程热度统计等需要快速访问的数据 |
| 对象存储 | `<<object storage>>` | 存储反馈截图、操作录屏、导出的课表文件等非结构化数据 |

#### 2.2.3 构件间关系说明

**（1）接口实现关系（Implementation）**

业务层的6个服务构件分别实现对应的接口，遵循"面向接口编程"原则：

```
时间偏好管理服务 ──实现──► ITimePreference
课程信息服务     ──实现──► ICourseInfo
意愿表达服务     ──实现──► IWishExpression
排课结果服务     ──实现──► IScheduleResult
反馈支持服务     ──实现──► IFeedbackService
通知服务         ──实现──► INotification
```

**（2）层间调用关系（Dependency）**

| 调用方 | 被调用方 | 关系类型 | 说明 |
|--------|----------|----------|------|
| 表现层构件 | API网关 | `<<HTTP>>` | 所有前端请求通过HTTP协议统一经过API网关 |
| API网关 | 业务层服务 | `<<call>>` | 网关将请求路由分发到对应的业务服务 |
| 业务层服务 | 数据访问对象 | `<<access>>` | 业务服务通过DAO访问持久化数据 |
| 业务层服务 | 缓存管理器 | `<<cache>>` | 业务服务通过缓存管理器读写缓存数据 |
| 数据访问对象 | MySQL数据库 | `<<persist>>` | DAO将数据持久化到MySQL |
| 缓存管理器 | Redis缓存 | `<<store>>` | 缓存管理器将数据存储到Redis |

**（3）业务层内部协作关系**

| 协作关系 | 类型 | 说明 |
|----------|------|------|
| 时间偏好管理服务 → 意愿表达服务 | `<<use>>` | 意愿表达时需要获取学生的时间偏好数据进行冲突检测 |
| 课程信息服务 → 意愿表达服务 | `<<use>>` | 意愿表达时需要获取课程详细信息和先修课要求 |
| 意愿表达服务 → 排课结果服务 | `<<send>>` | 提交的意愿数据传递给排课结果服务进行处理 |
| 反馈支持服务 → 通知服务 | `<<notify>>` | 用户提交反馈后触发通知确认 |

**（4）外部系统接口**

| 本系统构件 | 外部系统 | 关系类型 | 说明 |
|------------|----------|----------|------|
| API网关 | 统一身份认证 | `<<authenticate>>` | 验证学生登录身份，获取用户信息 |
| 通知服务 | 邮件/短信网关 | `<<send>>` | 发送邮件和短信通知 |
| 排课结果服务 | 教务协调子系统 | `<<export>>` | 将学生意愿数据导出给教务协调子系统进行统一排课 |

#### 2.2.4 数据流向说明

```
学生操作 → Web/移动端 → API网关 → 业务服务 → 数据访问层 → 数据存储层
                ↓
           身份认证 ←→ 统一身份认证系统
                ↓
           意愿数据 ──→ 教务协调子系统
                ↓
           通知消息 ──→ 邮件/短信网关
```

---

## 三、关键接口定义

基于系统架构图，选取以下三个核心接口进行定义：

### 3.1 时间偏好管理接口（ITimePreferenceService）

| 项目 | 描述 |
|------|------|
| **接口名称** | ITimePreferenceService |
| **所属构件** | 时间偏好管理服务（preference） |
| **接口功能** | 提供学生时间偏好的完整生命周期管理，包括创建、查询、更新、删除偏好设置，支持模板应用、冲突检测和历史偏好复用功能。该接口是排课算法获取学生时间约束的核心数据源。 |

**主要方法：**

```java
public interface ITimePreferenceService {
    
    /**
     * 创建或更新时间偏好
     * @param studentId 学生ID
     * @param preference 时间偏好对象，包含多个时间段设置
     * @return 保存后的时间偏好（含版本号）
     */
    TimePreference savePreference(String studentId, TimePreference preference);
    
    /**
     * 获取学生当前时间偏好
     * @param studentId 学生ID
     * @return 当前生效的时间偏好
     */
    TimePreference getCurrentPreference(String studentId);
    
    /**
     * 获取历史偏好列表（最近4个学期）
     * @param studentId 学生ID
     * @return 历史偏好列表
     */
    List<TimePreference> getHistoryPreferences(String studentId);
    
    /**
     * 应用偏好模板
     * @param studentId 学生ID
     * @param templateId 模板ID（如"上午优先"、"避免周末"）
     * @return 应用模板后的时间偏好
     */
    TimePreference applyTemplate(String studentId, String templateId);
    
    /**
     * 检测时间偏好冲突
     * @param preference 待检测的时间偏好
     * @return 冲突检测结果，包含冲突详情和修复建议
     */
    ConflictResult detectConflict(TimePreference preference);
    
    /**
     * 设置临时例外规则
     * @param studentId 学生ID
     * @param exception 例外规则（特定日期不可用）
     * @return 更新后的时间偏好
     */
    TimePreference addException(String studentId, TimeException exception);
}
```

---

### 3.2 意愿表达接口（IWishExpressionService）

| 项目 | 描述 |
|------|------|
| **接口名称** | IWishExpressionService |
| **所属构件** | 意愿表达服务（wish） |
| **接口功能** | 处理学生课程选择意愿的表达与管理，包括意愿创建、优先级设置、理由填写、意愿验证、冲突预警以及替代课程推荐。该接口将学生的主观需求转化为排课算法可处理的结构化数据。 |

**主要方法：**

```java
public interface IWishExpressionService {
    
    /**
     * 创建课程意愿
     * @param studentId 学生ID
     * @param courseId 课程ID
     * @param priority 优先级（3=必选，2=强烈想选，1=一般想选）
     * @param reason 选课理由（最多100字）
     * @return 创建的意愿对象
     */
    Wish createWish(String studentId, String courseId, int priority, String reason);
    
    /**
     * 获取学生意愿列表
     * @param studentId 学生ID
     * @return 该学生的所有课程意愿
     */
    WishList getWishList(String studentId);
    
    /**
     * 验证意愿完整性
     * @param wishList 待验证的意愿列表
     * @return 验证结果，包含错误信息
     */
    ValidationResult validateWishList(WishList wishList);
    
    /**
     * 智能冲突预警
     * @param studentId 学生ID
     * @param wishList 意愿列表
     * @return 冲突预警结果（时间冲突、学分冲突、先修课冲突）
     */
    List<ConflictWarning> detectConflicts(String studentId, WishList wishList);
    
    /**
     * 获取替代课程推荐
     * @param courseId 原课程ID
     * @param studentPreference 学生时间偏好
     * @return 替代课程列表（按匹配度排序）
     */
    List<AlternativeCourse> getAlternatives(String courseId, TimePreference studentPreference);
    
    /**
     * 提交意愿数据
     * @param studentId 学生ID
     * @param wishList 意愿列表
     * @return 提交结果，包含提交时间和版本号
     */
    SubmitResult submitWishList(String studentId, WishList wishList);
}
```

---

### 3.3 排课结果查询接口（IScheduleResultService）

| 项目 | 描述 |
|------|------|
| **接口名称** | IScheduleResultService |
| **所属构件** | 排课结果服务（schedule） |
| **接口功能** | 提供排课结果的查询、分析与导出功能，包括个人课表展示、时间偏好满足率计算、课程匹配状态查询、替代方案建议、课表导出以及变更通知管理。该接口是学生了解最终排课结果的核心入口。 |

**主要方法：**

```java
public interface IScheduleResultService {
    
    /**
     * 获取个人课表
     * @param studentId 学生ID
     * @param viewType 视图类型（WEEK/MONTH/LIST）
     * @return 格式化的课表数据
     */
    Schedule getSchedule(String studentId, ViewType viewType);
    
    /**
     * 获取时间偏好满足率分析
     * @param studentId 学生ID
     * @return 满足率报告，含与全校平均对比
     */
    SatisfactionReport getSatisfactionRate(String studentId);
    
    /**
     * 获取课程匹配状态
     * @param studentId 学生ID
     * @return 各课程匹配状态列表（已确定/待协调/冲突中/未匹配）
     */
    List<CourseMatchStatus> getCourseMatchStatus(String studentId);
    
    /**
     * 获取未匹配课程的替代方案
     * @param studentId 学生ID
     * @param courseId 未匹配的课程ID
     * @return 替代方案列表
     */
    List<AlternativeSuggestion> getAlternativeSuggestions(String studentId, String courseId);
    
    /**
     * 导出课表
     * @param studentId 学生ID
     * @param format 导出格式（PDF/PNG/JPEG/ICAL）
     * @return 导出文件的下载链接
     */
    String exportSchedule(String studentId, ExportFormat format);
    
    /**
     * 获取变更历史记录
     * @param studentId 学生ID
     * @return 课表变更历史列表
     */
    List<ChangeRecord> getChangeHistory(String studentId);
    
    /**
     * 获取排课变更通知
     * @param studentId 学生ID
     * @return 未读通知列表
     */
    List<Notification> getChangeNotifications(String studentId);
}
```

---

## 四、技术栈选择

> **说明**：本系统作为"双向选择排课系统"的学生端子系统，需与教师排课子系统、教务协调子系统协同工作。技术栈选择兼顾开发效率、学习成本和子系统间的集成便利性，适合在Windows本地环境进行开发和演示。

### 4.1 技术栈总览

| 层次 | 技术选型 | 选择理由 |
|------|----------|----------|
| **前端框架** | Vue.js 3 + JavaScript | 轻量级响应式框架，学习曲线平缓，适合快速开发 |
| **UI组件库** | Element Plus | 丰富的组件库，开箱即用，支持响应式布局 |
| **构建工具** | Vite | 快速的开发服务器，热更新体验好，配置简单 |
| **后端框架** | Spring Boot 3 | 单体应用架构，配置简单，内置Tomcat无需额外部署 |
| **ORM框架** | MyBatis-Plus | 简化数据库操作，代码生成器提高开发效率 |
| **接口规范** | RESTful API | 标准化接口设计，便于三个子系统间相互调用 |
| **关系数据库** | MySQL 8.0 | Windows安装简单，可视化工具丰富（Navicat/DBeaver） |
| **接口文档** | Swagger/Knife4j | 自动生成API文档，便于前后端联调和子系统集成 |
| **开发工具** | VS Code + IDEA | 前端用VS Code，后端用IDEA，两者均有良好的Windows支持 |
| **版本控制** | Git | 便于代码管理和团队协作 |

### 4.2 技术架构说明

本系统采用前后端分离的技术架构，整体分为四个层次：

**（1）客户端层**

用户通过Chrome、Edge、Firefox等现代浏览器访问系统。前端采用Vue.js 3框架开发，使用Vite作为构建工具，开发环境运行在5173端口。

**（2）前端应用层**

前端应用包含四个主要页面模块：
- **时间偏好设置页面**：提供周视图日历，支持拖拽设置时间段偏好
- **课程选择浏览页面**：展示课程列表，支持筛选、排序和详情查看
- **意愿表达提交页面**：设置课程优先级，填写选课理由，提交意愿
- **结果查看导出页面**：查看个人课表，分析匹配结果，导出多种格式

技术栈：Vue 3 + Vue Router + Pinia + Element Plus + Axios

**（3）后端应用层**

后端采用Spring Boot 3单体架构，内嵌Tomcat服务器运行在8080端口。代码结构遵循三层架构：
- **Controller控制层**：PreferenceController、CourseController、WishController、ScheduleController，负责接收HTTP请求
- **Service业务层**：PreferenceService、CourseService、WishService、ScheduleService，实现核心业务逻辑
- **Mapper数据层**：StudentMapper、CourseMapper、WishMapper、ScheduleMapper，封装数据库操作

技术栈：Spring Boot 3 + MyBatis-Plus + Knife4j

**（4）数据存储层**

使用MySQL 8.0关系型数据库，运行在3306端口。主要数据表包括：
- student（学生表）、course（课程表）、wish（意愿表）、schedule（排课结果表）
- preference（时间偏好表）、time_slot（时间段表）、feedback（反馈表）

可使用Navicat、DBeaver或MySQL Workbench进行数据库管理。

### 4.3 子系统集成说明

**（1）整体系统构成**

双向选择排课系统由三个子系统组成，各子系统独立部署，通过RESTful API和共享数据库进行集成：

| 子系统 | 端口 | 主要功能 |
|--------|------|----------|
| 学生排课子系统（本系统） | 8081 | 时间偏好管理、课程选择浏览、意愿表达提交、排课结果查看 |
| 教师排课子系统 | 8082 | 课程时间设置、教室偏好设置、授课意愿表达、课表查看确认 |
| 教务协调子系统 | 8083 | 汇总学生/教师意愿、执行排课算法、资源冲突协调、发布最终课表 |

**（2）数据共享机制**

三个子系统共用同一个MySQL数据库，通过不同的表进行数据隔离。共享表（如course、schedule）由教务协调子系统主导维护，各子系统通过API读取。

**（3）接口调用关系**

- 学生排课子系统 → 教务协调子系统：提交学生意愿数据，获取最终排课结果
- 教师排课子系统 → 教务协调子系统：提交教师意愿数据，获取最终排课结果
- 教务协调子系统：汇总两端意愿，执行排课算法，发布统一课表

### 4.4 本地开发环境配置

**Windows环境所需软件：**

| 软件 | 版本要求 | 用途 | 下载方式 |
|------|----------|------|----------|
| JDK | 17+ | 运行Spring Boot | Oracle官网 / AdoptOpenJDK |
| Node.js | 18+ | 运行Vue前端 | nodejs.org |
| MySQL | 8.0 | 数据库 | MySQL官网安装包 |
| VS Code | 最新版 | 前后端统一开发 | code.visualstudio.com |
| Git | 最新版 | 版本控制 | git-scm.com |

**VS Code 必装扩展（前后端一体化开发）：**

| 扩展名称 | 扩展ID | 用途 |
|----------|--------|------|
| Extension Pack for Java | vscjava.vscode-java-pack | Java语言支持（含调试、Maven等） |
| Spring Boot Extension Pack | vmware.vscode-boot-dev-pack | Spring Boot开发支持 |
| Vue - Official | Vue.volar | Vue 3语法支持 |
| Element Plus Snippets | element-plus-snippets | Element Plus代码片段 |
| MySQL | cweijan.vscode-mysql-client2 | 数据库可视化管理 |

**本地启动步骤：**

```powershell
# 1. 启动MySQL服务（Windows服务或命令行）
net start mysql

# 2. 启动后端（VS Code终端）
cd student-schedule-backend
./mvnw spring-boot:run    # 使用Maven Wrapper，无需安装Maven

# 3. 启动前端（VS Code新开终端）
cd student-schedule-frontend
npm install
npm run dev

# 4. 访问系统
# 前端页面: http://localhost:5173
# 后端API文档: http://localhost:8080/doc.html
```

**VS Code 工作区建议：**
```
双向选择排课系统/
├── student-schedule-frontend/    # 学生端前端 (Vue.js)
├── student-schedule-backend/     # 学生端后端 (Spring Boot)
└── .vscode/
    └── settings.json             # 工作区统一配置
```

### 4.5 技术选型与需求对应

| 需求要求 | 轻量级技术方案 |
|----------|----------------|
| 5000并发用户 | Spring Boot内置线程池 + 数据库连接池（HikariCP） |
| 页面加载<2秒 | Vite构建优化 + 组件懒加载 + 静态资源压缩 |
| 操作响应<500ms | MyBatis-Plus高效查询 + 合理的数据库索引 |
| 99.5%可用性 | 开发阶段暂不考虑，生产环境可后续升级 |
| WCAG 2.1无障碍 | Element Plus内置无障碍支持 |
| 多终端适配 | Element Plus响应式布局 + CSS媒体查询 |
| 80%测试覆盖率 | JUnit5 + Vitest（前端测试） |
| 子系统集成 | 统一的RESTful API规范 + 共享数据库 |

---

## 五、总结

本概要设计文档基于学生排课子系统的需求分析，完成了以下设计工作：

1. **架构风格选择**：采用分层架构与微服务思想相结合的混合架构，兼顾系统的清晰性、可扩展性和高可用性。

2. **系统架构设计**：通过UML构件图和包图，将系统分解为表现层、业务逻辑层、数据访问层和数据存储层四个层次，业务层内部划分为时间偏好管理、课程信息、意愿表达、排课结果、反馈支持和通知六个核心服务。

3. **关键接口定义**：详细定义了ITimePreferenceService、IWishExpressionService和IScheduleResultService三个核心接口，涵盖了系统的主要业务功能。

4. **技术栈规划**：选择了Vue.js 3 + Spring Boot 3 + MySQL + Redis的主流技术栈，配合Docker/K8s容器化部署，确保系统能够满足性能、可用性和可维护性要求。

本设计方案充分考虑了需求文档中提出的各项功能和非功能需求，为后续的详细设计和开发实现奠定了坚实基础。
